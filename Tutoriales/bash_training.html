<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jeronimo Miranda">

<title>Bash 102</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="bash_training_files/libs/clipboard/clipboard.min.js"></script>
<script src="bash_training_files/libs/quarto-html/quarto.js"></script>
<script src="bash_training_files/libs/quarto-html/popper.min.js"></script>
<script src="bash_training_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="bash_training_files/libs/quarto-html/anchor.min.js"></script>
<link href="bash_training_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="bash_training_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="bash_training_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="bash_training_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="bash_training_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Bash 102</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jeronimo Miranda </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="algunos-trucos-extra-en-bash" class="level2">
<h2 class="anchored" data-anchor-id="algunos-trucos-extra-en-bash">Algunos trucos extra en BASH</h2>
<p>Usar la terminal es un cambio respecto a lo que hacemos diariamente en la computadora. Significa usar muy poco el raton y escribir directamente todo lo que queremos que haga la computadora.</p>
<p>Sin embargo, esto de escribir todo puede llegar a ser cansado y tedioso. Existen atajos para escribir menos?</p>
<section id="expansion-con" class="level3">
<h3 class="anchored" data-anchor-id="expansion-con">Expansion con “{}”</h3>
<p>Uno de los atajos que usamos para escribir menos es el uso de la expansion con corchetes {}. La expresion dentro de los corchetes se “expande” para cada elemento.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> pedro-<span class="dt">{Pedro</span><span class="op">,</span><span class="dt">PEDRO</span><span class="op">,</span><span class="dt">pe}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>pedro-Pedro pedro-PEDRO pedro-pe</code></pre>
</div>
</div>
<p>Esto es util si no se quiere escribir un comando repetitivo, por ejemplo, digamos que queremos hacer un directorio para nuestro proyecto de metagenoma, pero queremos mantener organizado nuestro directorio con un sub-directorio para graficas, otro para los datos, y otro donde guardar nuestros scripts. Entonces, asumiendo que estamos en <code>/home/nombredeusuario</code> podemos escribir, en una linea: <strong>Es importante que no haya espacios dentro del {}, solo ,</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> metagenoma/<span class="dt">{secuencias</span><span class="op">,</span><span class="dt">scripts</span><span class="op">,</span><span class="dt">analisis/graficas}</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> metagenoma</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>analisis
scripts
secuencias</code></pre>
</div>
</div>
<p>Cuando hay mas de un grupo de corchetes, se expanden todas las combinaciones. Esto puede ser util para operaciones repetitivas en archivos. Por ejemplo, es comun trabajar con archivos de la forma <code>nombre-Control1_Read1.fastq</code> <code>nombre-Control1_Read2.fastq</code>. Como podemos procesar estos archivos sin tener que escribirlos todos o copiar y pegar muchas veces? Usamos <code>echo</code> que solo imprime los nombres, pero podriamos sustituir cualquier programa como <code>fastq</code> que usaremos esta semana:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> nombre-<span class="dt">{Control</span><span class="op">,</span><span class="dt">Tratado}{</span><span class="dv">1</span><span class="dt">..</span><span class="dv">9</span><span class="dt">}</span>_Read<span class="dt">{1</span><span class="op">,</span><span class="dt">2}</span>.fastq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>nombre-Control1_Read1.fastq nombre-Control1_Read2.fastq nombre-Control2_Read1.fastq nombre-Control2_Read2.fastq nombre-Control3_Read1.fastq nombre-Control3_Read2.fastq nombre-Control4_Read1.fastq nombre-Control4_Read2.fastq nombre-Control5_Read1.fastq nombre-Control5_Read2.fastq nombre-Control6_Read1.fastq nombre-Control6_Read2.fastq nombre-Control7_Read1.fastq nombre-Control7_Read2.fastq nombre-Control8_Read1.fastq nombre-Control8_Read2.fastq nombre-Control9_Read1.fastq nombre-Control9_Read2.fastq nombre-Tratado1_Read1.fastq nombre-Tratado1_Read2.fastq nombre-Tratado2_Read1.fastq nombre-Tratado2_Read2.fastq nombre-Tratado3_Read1.fastq nombre-Tratado3_Read2.fastq nombre-Tratado4_Read1.fastq nombre-Tratado4_Read2.fastq nombre-Tratado5_Read1.fastq nombre-Tratado5_Read2.fastq nombre-Tratado6_Read1.fastq nombre-Tratado6_Read2.fastq nombre-Tratado7_Read1.fastq nombre-Tratado7_Read2.fastq nombre-Tratado8_Read1.fastq nombre-Tratado8_Read2.fastq nombre-Tratado9_Read1.fastq nombre-Tratado9_Read2.fastq</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> metagenoma/secuencias/nombre-<span class="dt">{Control</span><span class="op">,</span><span class="dt">Tratado}{</span><span class="dv">1</span><span class="dt">..</span><span class="dv">9</span><span class="dt">}</span>_Read<span class="dt">{1</span><span class="op">,</span><span class="dt">2}</span>.fastq</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> metagenoma/secuencias</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>nombre-Control1_Read1.fastq
nombre-Control1_Read2.fastq
nombre-Control2_Read1.fastq
nombre-Control2_Read2.fastq
nombre-Control3_Read1.fastq
nombre-Control3_Read2.fastq
nombre-Control4_Read1.fastq
nombre-Control4_Read2.fastq
nombre-Control5_Read1.fastq
nombre-Control5_Read2.fastq
nombre-Control6_Read1.fastq
nombre-Control6_Read2.fastq
nombre-Control7_Read1.fastq
nombre-Control7_Read2.fastq
nombre-Control8_Read1.fastq
nombre-Control8_Read2.fastq
nombre-Control9_Read1.fastq
nombre-Control9_Read2.fastq
nombre-Tratado1_Read1.fastq
nombre-Tratado1_Read2.fastq
nombre-Tratado2_Read1.fastq
nombre-Tratado2_Read2.fastq
nombre-Tratado3_Read1.fastq
nombre-Tratado3_Read2.fastq
nombre-Tratado4_Read1.fastq
nombre-Tratado4_Read2.fastq
nombre-Tratado5_Read1.fastq
nombre-Tratado5_Read2.fastq
nombre-Tratado6_Read1.fastq
nombre-Tratado6_Read2.fastq
nombre-Tratado7_Read1.fastq
nombre-Tratado7_Read2.fastq
nombre-Tratado8_Read1.fastq
nombre-Tratado8_Read2.fastq
nombre-Tratado9_Read1.fastq
nombre-Tratado9_Read2.fastq</code></pre>
</div>
</div>
</section>
</section>
<section id="piping-la-filosofia-modular-de-unix" class="level2">
<h2 class="anchored" data-anchor-id="piping-la-filosofia-modular-de-unix">Piping: la filosofia modular de UNIX</h2>
<p>Hasta ahora, hemos visto que los resultados de los comandos aparecen en la pantalla, a esto se le conoce como standard output.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"TGAATGAAAAATTTAAGCATTGTTTGCTTATTGTTCCAAGACATTGTCAATAAAAGCATTTAAGTTGAAT"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TGAATGAAAAATTTAAGCATTGTTTGCTTATTGTTCCAAGACATTGTCAATAAAAGCATTTAAGTTGAAT</code></pre>
</div>
</div>
<p>En su lugar, podemos <strong>redirigir</strong> este output al <strong>standard input</strong> de otro programa, para esto, uno de los simbolos mas importantes en UNIX es la barra vertical <code>|</code> a la que tambien se le conoce como <strong>pipe</strong> o tuberia, porque transmite los datos de un lugar a otro. Por ejemplo aqui redirigimos al programa <code>tr T U</code> que cambia todas las Ts por Us para transformar la secuencia de DNA a RNA.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"TGAATGAAAAATTTAAGCATTGTTTGCTTATTGTTCCAAGACATTGTCAATAAAAGCATTTAAGTTGAAT"</span> <span class="kw">|</span> <span class="fu">tr</span> T U </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>UGAAUGAAAAAUUUAAGCAUUGUUUGCUUAUUGUUCCAAGACAUUGUCAAUAAAAGCAUUUAAGUUGAAU</code></pre>
</div>
</div>
<p>Esto se sigue redireccionando al standar output despues de pasar por <code>tr</code>. Tambien podemos redireccionar a un archivo (y crear el archivo al mismo tiempo) con <code>&gt;</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"TGAATGAAAAATTTAAGCATTGTTTGCTTATTGTTCCAAGACATTGTCAATAAAAGCATTTAAGTTGAAT"</span> <span class="kw">|</span> <span class="fu">tr</span> T U <span class="op">&gt;</span> secuencia_rna.fa</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>En este caso no se imprimio nada a la pantalla, pero se creo el archivo <code>secuencia_rna.fa</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> secuencia_rna.fa</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>UGAAUGAAAAAUUUAAGCAUUGUUUGCUUAUUGUUCCAAGACAUUGUCAAUAAAAGCAUUUAAGUUGAAU</code></pre>
</div>
</div>
<p>Pero se nos olvido poner el nombre de la secuencia en el archivo! Ademas, queremos que todas las As sean minusculas y queremos el reverso de la secuencia, porque si. Con el menor que, <code>&lt;</code> redirigimos al <strong>standard input.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tr</span> A a <span class="op">&lt;</span> secuencia_rna.fa <span class="kw">|</span> <span class="fu">rev</span> <span class="kw">|</span> <span class="fu">cat</span> <span class="op">&lt;(</span><span class="bu">echo</span> <span class="st">"&gt;secuencia rna"</span><span class="op">)</span> <span class="at">-</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&gt;secuencia rna
UaaGUUGaaUUUaCGaaaaUaaCUGUUaCaGaaCCUUGUUaUUCGUUUGUUaCGaaUUUaaaaaGUaaGU</code></pre>
</div>
</div>
<p>Esto parece complicado pero con un poco de practica, se vuelve simple y ademas muy comodo:</p>
<ol type="1">
<li><p><code>&lt; secuencia_rna.fa</code> manda el contenido del archivo al standar input, que es recogido por</p></li>
<li><p><code>tr A a</code> que convierte todas las As mayusculas a minusculas, entonces el pipe <code>|</code> redirige el standard output de esto a</p></li>
<li><p><code>rev</code> que es un programa que invierte su standard input y lo escribe a standard output, con <code>|</code> lo volvemos a redirigir a</p></li>
<li><p><code>cat</code> un programa que concatena todos sus argumentos en orden. El primer argumento para cat es <strong>otro</strong> standard input que hicimos con <code>&lt;(echo "&gt;secuencia rna")</code> ademas del standard input que venia desde antes, que representamos con <code>-</code>. Que sucede si inviertes el orden de los dos argumentos de cat?</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tr</span> A a <span class="op">&lt;</span> secuencia_rna.fa <span class="kw">|</span> <span class="fu">rev</span> <span class="kw">|</span> <span class="fu">cat</span> <span class="at">-</span> <span class="op">&lt;(</span><span class="bu">echo</span> <span class="st">"&gt;secuencia rna"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>UaaGUUGaaUUUaCGaaaaUaaCUGUUaCaGaaCCUUGUUaUUCGUUUGUUaCGaaUUUaaaaaGUaaGU
&gt;secuencia rna</code></pre>
</div>
</div>
<p>Otro comando util aqui es <code>&gt;&gt;</code> que tambien redirige a un archivo al igual que <code>&gt;</code> pero no sobreescribe el contenido, sino que solo lo anade al final.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tr</span> A a <span class="op">&lt;</span> secuencia_rna.fa <span class="kw">|</span> <span class="fu">rev</span> <span class="kw">|</span> <span class="fu">cat</span> <span class="op">&lt;(</span><span class="bu">echo</span> <span class="st">"&gt;secuencia rna"</span><span class="op">)</span> <span class="at">-</span> <span class="op">&gt;&gt;</span> secuencia_rna.fa</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> secuencia_rna.fa</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>UGAAUGAAAAAUUUAAGCAUUGUUUGCUUAUUGUUCCAAGACAUUGUCAAUAAAAGCAUUUAAGUUGAAU
&gt;secuencia rna
UaaGUUGaaUUUaCGaaaaUaaCUGUUaCaGaaCCUUGUUaUUCGUUUGUUaCGaaUUUaaaaaGUaaGU</code></pre>
</div>
</div>
<p>Ten cuidado! Por que en este caso estamos leyendo y escribiendo al mismo archivo. Que ocurre cuando corres exactamente el mismo comando dos o tres veces? Como cambia el archivo secuencia_rna.fa?</p>
<p>Algunos programas tienen otro output que no es para resultados sino para los errores conocido como <code>standard error</code>. Aunque no lo veremos aqui, si trabajas mucho con comandos como los que hemos visto, quizas quieras investigar sobre <code>2&gt;</code> y el comando <code>tee</code> y si te sientes con mas confianza, <code>xargs.</code></p>
<p>Como todo, hay un balance entre la simplicidad y la curva de aprendizaje, no tienes que aprenderte todos estos comandos, pero conforme te veas en la necesidad de trabajar mas y mas en la terminal, es util saber que existe una manera facil de procesar cientos o miles de archivos… Sientete libre de experimentar.</p>
</section>
<section id="scripting-en-bash" class="level2">
<h2 class="anchored" data-anchor-id="scripting-en-bash">Scripting en bash</h2>
<p>Una vez que tengamos practica con los comandos arriba mencionados, nuestros programas comenzaran a volverse mas complicados. Ya no es practico escribir un comando en la terminal, esperar a que termine, correr el siguiente comando, etc. etc. En su lugar, podemos escribir todos los comandos en un archivo y correr todo de una vez, esto se conoce como bash scripting.</p>
<p>Llamamos a <code>vi bashscript.sh</code> y escribimos:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Esta variable rara tiene el numero de argumentos</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="st">"</span><span class="va">$#</span><span class="st">"</span> <span class="ot">-lt</span> 1 <span class="bu">]</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="cf">then</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> <span class="st">"Quien eres?"</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="bu">exit</span> 1</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Hola </span><span class="va">$1</span><span class="st">, yo soy el programa </span><span class="va">$0</span><span class="st"> en </span><span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span><span class="st">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Guardamos y salimos con ESC y <strong><code>:wq</code></strong> Ahora corremos el programa con:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./bashscript.sh</span> <span class="va">$(</span><span class="fu">whoami</span><span class="va">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hola jerolon, yo soy el programa ./bashscript.sh
1</code></pre>
</div>
</div>
<p>No tenemos permiso? Veamos</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-l</span> <span class="kw">|</span> <span class="fu">grep</span> bashscript</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-rwxrwxrwx 1 jerolon jerolon   407 Jun  9 18:41 bashscript.sh</code></pre>
</div>
</div>
<p>La columna llena de <code>rwx</code> nos dice los permisos de la aplicacion que son: <code>r</code> permiso de lectura, <code>w</code> permiso de escritura, y <code>x</code> permiso de ejecucion. Esto esta repetido tres veces para el creador del archivo, el grupo del creador y todos los usuarios. Por ejemplo</p>
<p><code>-rw-rw-rw-</code> Quiere decir que todos pueden leer y escribir pero no puede ser ejecutado por nadie.</p>
<p><code>-rwxr-xr--</code> Quiere decir que el creador puede leer y modificar y ejecutar, pero el grupo solo puede leer y ejecutar. Los que no pertenezcan al grupo, solo pueden leer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x bashscript.sh</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="ex">./bashscript.sh</span> <span class="st">"Jeronimo"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hola Jeronimo, yo soy el programa ./bashscript.sh
1</code></pre>
</div>
</div>
<p>Ahora tenemos permiso para ejectuar. Incluso puedes ver que <code>ls</code> muestra el nombre del archivo en verde.</p>
<p>La condicion if es parecida a cualquier otro programa como python o R. Algunas comparaciones utiles al escribir scripts son:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co">#3 igual a 2?</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="bu">test</span> 2 <span class="at">-eq</span> 3<span class="kw">;</span> <span class="bu">echo</span> <span class="va">$?</span><span class="kw">;</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="bu">test</span> <span class="st">"ATG"</span> = <span class="st">"TGA"</span><span class="kw">;</span> <span class="bu">echo</span> <span class="va">$?</span><span class="kw">;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">#4 mayor que 1?</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="bu">test</span> 4 <span class="at">-gt</span> 1<span class="kw">;</span> <span class="bu">echo</span> <span class="st">"</span><span class="va">$?</span><span class="st">"</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co">#es un directorio?</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="bu">test</span> <span class="at">-d</span> metagenoma<span class="kw">;</span> <span class="bu">echo</span> <span class="st">"</span><span class="va">$?</span><span class="st">"</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co">#es un archivo?</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="bu">test</span> <span class="at">-f</span> metagenoma <span class="kw">;</span> <span class="bu">echo</span> <span class="st">"</span><span class="va">$?</span><span class="st">"</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co">#Existe?</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="bu">test</span> <span class="at">-e</span> metagenoma/analisis<span class="kw">;</span> <span class="bu">echo</span> <span class="st">"</span><span class="va">$?</span><span class="st">"</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"No sensible a mayusculas"</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="bu">test</span> <span class="at">-e</span> metagenoma/Analisis<span class="kw">;</span> <span class="bu">echo</span> <span class="st">"</span><span class="va">$?</span><span class="st">"</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="co">#Es ejecutable?</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="bu">test</span> <span class="at">-x</span> bashscript.sh<span class="kw">;</span> <span class="bu">echo</span> <span class="st">"</span><span class="va">$?</span><span class="st">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Prueba a escribirlos en la terminal o incluirlos en bashscript.sh. 0 es cuando la condicion es verdadera, 1 cuando la condicion no se cumple. Todas estas condiciones pueden usarse dentro de un <code>if [ ]</code> para controlar el flujo del programa.</p>
<section id="find" class="level3">
<h3 class="anchored" data-anchor-id="find">find</h3>
<p>El comando <code>find</code> es una especie de <code>ls</code> pero con un poco mas de poder, nos permite buscar en directorios y subdirectorios con bastante control sobre los elementos que queremos encontrar. Con <code>-type f</code> decimos que solo nos de nombres de archivos, y con <code>-name</code> podemos darle un patron que debe incluir el nombre del archivo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> metagenoma <span class="at">-type</span> f <span class="at">-name</span> <span class="st">"*Control5*"</span> <span class="at">-or</span> <span class="at">-name</span> <span class="st">"*Tratado6*"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>metagenoma/secuencias/nombre-Control5_Read1.fastq
metagenoma/secuencias/nombre-Control5_Read2.fastq
metagenoma/secuencias/nombre-Tratado6_Read1.fastq
metagenoma/secuencias/nombre-Tratado6_Read2.fastq</code></pre>
</div>
</div>
<p>Aqui, listamos todos los archivos con el primer read y los ordenamos.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> metagenoma <span class="at">-type</span> f <span class="at">-name</span> <span class="st">"*_Read1.fastq*"</span> <span class="kw">|</span> <span class="fu">sort</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>metagenoma/secuencias/nombre-Control1_Read1.fastq
metagenoma/secuencias/nombre-Control2_Read1.fastq
metagenoma/secuencias/nombre-Control3_Read1.fastq
metagenoma/secuencias/nombre-Control4_Read1.fastq
metagenoma/secuencias/nombre-Control5_Read1.fastq
metagenoma/secuencias/nombre-Control6_Read1.fastq
metagenoma/secuencias/nombre-Control7_Read1.fastq
metagenoma/secuencias/nombre-Control8_Read1.fastq
metagenoma/secuencias/nombre-Control9_Read1.fastq
metagenoma/secuencias/nombre-Tratado1_Read1.fastq
metagenoma/secuencias/nombre-Tratado2_Read1.fastq
metagenoma/secuencias/nombre-Tratado3_Read1.fastq
metagenoma/secuencias/nombre-Tratado4_Read1.fastq
metagenoma/secuencias/nombre-Tratado5_Read1.fastq
metagenoma/secuencias/nombre-Tratado6_Read1.fastq
metagenoma/secuencias/nombre-Tratado7_Read1.fastq
metagenoma/secuencias/nombre-Tratado8_Read1.fastq
metagenoma/secuencias/nombre-Tratado9_Read1.fastq</code></pre>
</div>
</div>
<p>Con pipes y variables, controlamos de manera flexible y poderosa los comandos que corremos en la terminal o en scripts. Prueba a anadir lo siguiente al final de bashscript.sh:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="va">reads1</span><span class="op">=</span><span class="va">$(</span><span class="fu">find</span> metagenoma <span class="at">-type</span> f <span class="at">-name</span> <span class="st">"*_Read1.fastq*"</span> <span class="kw">|</span> <span class="fu">sort</span> <span class="kw">|</span> <span class="fu">paste</span> <span class="at">-sd,</span><span class="va">)</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="va">reads2</span><span class="op">=</span><span class="va">$(</span><span class="fu">find</span> metagenoma <span class="at">-type</span> f <span class="at">-name</span> <span class="st">"*_Read2.fastq*"</span> <span class="kw">|</span> <span class="fu">sort</span> <span class="kw">|</span> <span class="fu">paste</span> <span class="at">-sd,</span><span class="va">)</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Programa_para_reads_pareados -lista_de_read_1_separada_comma </span><span class="va">$reads1</span><span class="st"> -lista_de_reads2_separada_comma </span><span class="va">$reads2</span><span class="st">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Programa_para_reads_pareados -lista_de_read_1_separada_comma  -lista_de_reads2_separada_comma </code></pre>
</div>
</div>
<p>Muchos programas que utlizaremos tienen esta estructura. Aunque es perfectamente posible escribir o hacer copy-paste para escribir el mismo comando (y de hecho asi lo haremos muchas veces en el curso para que sea mas claro lo que estamos haciendo), si algun dia te topas con que tienes que procesar cientos o miles de <em>reads</em> pareados, recuerda que existe una manera de hacerlo programaticamente.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./bashscript.sh</span> <span class="st">"Jero"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Hola Jero, yo soy el programa ./bashscript.sh
1</code></pre>
</div>
</div>
</section>
</section>
<section id="someter-trabajos-a-ken-con-slurm" class="level2">
<h2 class="anchored" data-anchor-id="someter-trabajos-a-ken-con-slurm">Someter trabajos a KEN con Slurm</h2>
<p>Finalmente, lo ultimo que necesitas para hacer bioinformatica aqui. En el cluster, rara vez corremos scripts directamente, sino que se los entregamos al administrador de colas <code>slurm</code>. Los scripts que le entregamos a slurm son basicamente scripts debash algo mas de informacion extra con los recursos que pedimos de RAM y CPUS, entre otras cosas. Copia lo siguiente en un archivo llamado <code>cualquiernombre.slurm</code>, modifica -J my_job , tu email y anade cualquera de los comandos que hemos visto al final del archivo.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Run job throughbash</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Your job name</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH -J first_slurm</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Use current working directory</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --chdir=./</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="co">#stdout and stderr</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=%x.o%j</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Send an email after the job has finished</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-user=jero.miranda.rod@gmail.com</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mail-type=</span><span class="re">END</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="co"># If modules are needed, source modules environment (Do not delete the next line):</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a><span class="bu">.</span> /etc/profile.d/modules.sh</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Add any modules you might require:</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a><span class="co">#Quiero que el programa corra en dos nodos</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH -p node -n 2</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a><span class="co">#Cada nodo con 2G de ram</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem-per-cpu=4G</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Write your commands in the next line</span></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a><span class="co">#A partir de aqui, puedes escribir los comandos</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>sbatch cualquiernombre.slurm</code></p>
<p>Listo!</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>